# Generated by ansible-awesome

config setup
#  charondebug="ike 1, knl 1, cfg 0"
#  charondebug="ike 4"

{% for c in (network_tunnels | default([])) %}
conn {{ c.name }}
  keyexchange=ikev2
  dpdaction=restart

  # peer IPs
  left={{ tunnel_outer }}
  right={{ c.outer }}

  # phase 1 parameters
  ike=aes256-sha256-modp2048!
  ikelifetime=28800s

{% if ((c.auth | default('pubkey')) == 'pubkey') %}
  # authentication
  leftauth=pubkey
  leftrsasigkey=/etc/strongswan/ipsec.d/public/{{ tunnel_outer }}.pem
  rightauth=pubkey
  rightrsasigkey=/etc/strongswan/ipsec.d/public/{{ c.outer }}.pem
{% endif %}
{% if ((c.auth | default('pubkey')) == 'cert') %}
  # authentication
  leftauth=pubkey
  leftcert=/etc/strongswan/ipsec.d/certs/{{ tunnel_outer }}.pem
  rightauth=pubkey
  rightca=/etc/strongswan/ipsec.d/cacerts/{{ c.ca | default('ca.illallangi.dn42') }}.pem
  rightid="{{ c.id }}"
{% endif %}

  # phase 2 parameters
  esp=aes256-sha256-modp2048!
  lifetime=3600s
  type=transport
  leftprotoport=gre
  rightprotoport=gre
  
  # startup
  auto=start
  keyingtries=%forever
  
{% endfor %}
